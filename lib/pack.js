var je=Object.create;var $=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames;var qe=Object.getPrototypeOf,Pe=Object.prototype.hasOwnProperty;var Re=(e,t)=>{for(var o in t)$(e,o,{get:t[o],enumerable:!0})},K=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of $e(t))!Pe.call(e,n)&&n!==o&&$(e,n,{get:()=>t[n],enumerable:!(r=we(t,n))||r.enumerable});return e};var s=(e,t,o)=>(o=e!=null?je(qe(e)):{},K(t||!e||!e.__esModule?$(o,"default",{value:e,enumerable:!0}):o,e)),Oe=e=>K($({},"__esModule",{value:!0}),e);var Le={};Re(Le,{decryptSignedKey:()=>ie,default:()=>ke,encryptKey:()=>re,getNodeLib:()=>Q,getProjectPath:()=>W,getStyleLoaderUse:()=>R,getWebpackConfig:()=>b,injectHtml:()=>V,run:()=>Ae,uploadAliOss:()=>ce});module.exports=Oe(Le);var ae=s(require("path")),P=s(require("fs")),C=s(require("process")),h=s(require("chalk")),L=s(require("glob")),T=s(require("mini-css-extract-plugin")),me=s(require("css-minimizer-webpack-plugin")),ue=s(require("@pmmmwh/react-refresh-webpack-plugin")),pe=s(require("webpackbar")),fe=require("clean-webpack-plugin"),de=s(require("webpack-dev-server")),O=s(require("webpack")),ge=s(require("webpack-merge")),he=s(require("html-webpack-plugin")),ye=require("address");var F=`
<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"
    />
    <meta name="format-detection" content="telephone=no, email=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <title></title>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>`;var M=s(require("chalk")),U=s(require("path")),q=s(require("fs")),N=s(require("webpack")),G=s(require("process")),J=s(require("webpack-node-externals")),B=s(require("cheerio")),X=s(require("webpack-merge")),Y=require("process"),W=(e="./")=>U.default.join(G.default.cwd(),e),Q=(e,t,o)=>{typeof t=="function"&&(o=t,t="./ssr-lib");let r=b(!1,e,"","node"),n={entry:e,externals:[(0,J.default)()],output:{path:W(t),filename:"[name].js",library:{type:"commonjs2"}}},l=(0,X.default)({},r,n),i=(0,N.default)(l);i.run((c,a)=>{(c||a.hasErrors())&&console.log(c.stack||c.message||c),i.close(()=>{console.log(M.default.green("library done \u{1F37A} ")),o?.()})})},V=(e,t="",o="#root")=>{if(q.default.existsSync(e))try{let r=q.default.readFileSync(e,{encoding:"utf-8"}),n=B.default.load(r);n(o).html(t),q.default.writeFileSync(e,n.html())}catch(r){console.error(r),(0,Y.exit)(1)}else console.error(e+"does not exist")};var ee=s(require("ali-oss")),A=s(require("crypto")),k=s(require("path")),g=s(require("fs")),te=s(require("fs-extra")),S=s(require("chalk")),v=s(require("process")),oe=s(require("draftlog"));oe.default.into(console);var Z=["prd","test"],Ee=async(e,t,o)=>{let r={test:"t-dist",prd:"dist"};o||j("env is required"),Z.indexOf(o)===-1&&j("env must be "+Z),te.default.pathExistsSync(k.default.resolve(v.default.cwd(),r[o]))||j("dist not exit");let{region:n,accessKeyId:l,accessKeySecret:i,bucket:c}=e,a=new ee.default({region:n,accessKeyId:l,accessKeySecret:i,bucket:c}),m=0;async function u(f,w){try{m++,await a.put(f,w),m--}catch(x){j(x)}}function p(f,w){g.default.readdirSync(f).forEach(x=>{var D=k.default.join(f,x),I=g.default.lstatSync(D);I.isFile()?u(`${w}${x}`,D):I.isDirectory()&&p(D,`${w}${x}/`)})}let E=k.default.resolve(v.default.cwd(),`./${r[o]}/`);p(E,`${o}/${t}/`);let y=0,z=["-","\\","|","/"],Se=console.draft();function ve(f){return y=(y+1)%z.length,S.default.green(z[y])+" "+S.default.green(f)}let H=()=>{m===0?(console.log(S.default.green(`${o==="prd"?"production":"non-production"} uploaded`)),Ce()):(Se(ve("oss uploading...")),setTimeout(H,60))};H();function j(f){console.log(S.default.red(f)),v.default.exit(9)}function Ce(){(g.default.rmSync?g.default.rmSync:g.default.rmdirSync)(k.default.resolve(v.default.cwd(),`./${r[o]}`),{recursive:!0})}},se="9vApxLk5G3PAsJXM",ne="FnJL7EDzjqWjcaX9";function re(e){let t="",o=A.default.createCipheriv("aes-128-cbc",se,ne);return t+=o.update(e,"utf8","hex"),t+=o.final("hex"),t}function ie(e){let t="",o=A.default.createDecipheriv("aes-128-cbc",se,ne);return t+=o.update(e,"hex","utf8"),t+=o.final("utf8"),t}var ce=Ee;var xe=9e3,d=(e="./")=>ae.default.join(C.default.cwd(),e);function _(e){console.log(h.default.red(e)),C.default.exit(9)}var R=(e="less",t,o)=>{let r=[{loader:require.resolve("css-loader"),options:{sourceMap:t}},{loader:require.resolve("postcss-loader"),options:{postcssOptions:{plugins:[require("postcss-preset-env")({autoprefixer:{flexbox:"no-2009"},stage:3})],sourceMap:t}}}];switch(e){case"less":{r.push({loader:require.resolve("less-loader"),options:{lessOptions:{relativeUrls:!1,javascriptEnabled:!0},sourceMap:t}});break}case"sass":{r.push({loader:require.resolve("sass-loader"),options:{sourceMap:t}});break}case"custom":{if(typeof o=="function"){let n=o();n&&(r=r.concat(n))}break}}return t?r.unshift({loader:require.resolve("style-loader")}):r.unshift({loader:T.default.loader}),r},De=e=>{let t=[[require.resolve("@babel/plugin-transform-runtime")],[require.resolve("@babel/plugin-proposal-decorators"),{legacy:!0}],[require.resolve("@babel/plugin-proposal-class-properties"),{loose:!1}]];return e&&t.push([require.resolve("react-refresh/babel")]),{cacheDirectory:!0,presets:[[require.resolve("@babel/preset-env"),{modules:"auto"}],[require.resolve("@babel/preset-react"),{runtime:"automatic"}],require.resolve("@babel/preset-typescript")],plugins:t}},le=e=>({type:"asset",parser:{dataUrlCondition:{maxSize:8*1024}},generator:{filename:`${e}/[name].[hash:8][ext]`}}),We=(e=[],t)=>{let o=P.default.existsSync(d("./index.tpl.js"));!o&&!P.default.existsSync(d("./index.html"))&&P.default.writeFileSync(d("./index.html"),F);let r=[];for(let n of e)r.push(new he.default(Object.assign({filename:`${n}.html`,[o&&!t?"templateContent":"template"]:o&&!t?({htmlWebpackPlugin:l})=>require(d("./index.tpl.js"))(l):d("index.html"),chunks:[n,"vendor","common","runtime"]},t?void 0:{minify:{removeComments:!0,collapseWhitespace:!0,removeRedundantAttributes:!0,useShortDoctype:!0,removeEmptyAttributes:!0,removeStyleLinkTypeAttributes:!0,keepClosingSlash:!0,minifyJS:!0,minifyCSS:!0,minifyURLs:!0}})));return r},b=(e=!0,t={},o="/",r="web",n)=>{let l=Object.keys(t),i=r==="node",c=i?[]:We(l,e),a=l.join("-"),m=i?[{test:/\.(less|sass|scss|css)$/,use:require.resolve("./ignore")}]:[{test:/\.less$/,use:R("less",e)},{test:/\.s[ac]ss$/i,use:R("sass",e)},{test:/\.css$/,use:R("css",e)}],u=[new fe.CleanWebpackPlugin,new O.default.DefinePlugin({__dev__:e})];typeof n=="string"&&n.trim()&&u.push(new pe.default({name:n})),i||(u.push(new T.default({filename:"[name].[contenthash:6].css",chunkFilename:"[name].[contenthash:6].css"})),u.push(...c));let p={mode:e?"development":"production",bail:!e,entry:t,output:{path:d("./dist"),chunkFilename:"[name].[contenthash:6].js",filename:e?"[name].js":"[name].[contenthash:6].js",publicPath:o},devtool:e?"cheap-module-source-map":!1,target:r,cache:i?!1:e?{type:"filesystem",name:a,buildDependencies:{config:[__filename]},store:"pack"}:{type:"filesystem",name:a+"-prd",buildDependencies:{config:[__filename]},store:"pack"},module:{rules:[{test:/\.[j|t]sx?$/,exclude:/node_modules/,use:{loader:require.resolve("babel-loader"),options:De(e)}},{test:/\.(png|jpg|gif|jpeg|svg)$/,...le("images")},{test:/\.(ttf|otf|woff|woff2|eot)$/,...le("fonts")},...m]},resolve:{extensions:[".js",".jsx",".ts",".tsx"],alias:{"~":d("./src"),"@":d("./src")}},optimization:{splitChunks:{name:!1,cacheGroups:{common:{name:"common",chunks:"all",minChunks:2},vendor:{name:"vendor",test:/[\\/]node_modules[\\/]/,chunks:"all",priority:10}}},runtimeChunk:i?!1:{name:"runtime"},moduleIds:e?"named":"deterministic",chunkIds:e?"named":"deterministic"},stats:"errors-warnings",plugins:u};return e?p.plugins.push(new ue.default({overlay:!1})):p.optimization={...p.optimization,minimize:!0,minimizer:[new me.default,"..."]},p},be=(e,t="index",o,r,n,l)=>{if(o){let i=(0,O.default)(e),c={compress:!0,host:"0.0.0.0",disableHostCheck:!0,hot:!0,inline:!0,noInfo:!0,sockPort:"location",...n},a=c.port||r,m=new de.default(i,c);m.listen(a,c.host,u=>{u&&_(u);let p=`${t==="index"?"":t+".html"}`,E=`http://localhost:${a}/${p}`,y=`http://${(0,ye.ip)()}:${a}/${p}`;console.log(h.default.cyan("dev server is listening at")),console.log(),console.log("> Local:",h.default.green(`${E}`)),console.log(),console.log("> Network:",h.default.green(`${y}`))}),["SIGINT","SIGTERM"].forEach(u=>{C.default.on(u,()=>{m&&m.close(),C.default.exit()})})}else{let i=(0,O.default)(e);i.run((c,a)=>{(c||a.hasErrors())&&console.log(a),i.close(()=>{console.log(h.default.green("done \u{1F37A} ")),l?.()})})}},Ae=(e="index",t="/",o=!0,r=xe)=>{let n=L.default.sync(`./src/${e}/index{.jsx,.js,.ts,.tsx}`),l=!0;n.length||(n=L.default.sync("./src/index{.jsx,.js,.ts,.tsx}"),n.length||_(`Entry not found : ${d("./src/index")}`),l=!1);let i=n[0],c=b(o,{[e]:i},t);be(c,l?e:"index",o,r)};function ke(e,t,o,r){let{entry:n,devServer:l={},...i}=t;if(typeof n=="object"&&n&&Object.keys(n).length){let c=Object.keys(n),a=b(e,n,"/","web",r||"app"),m=(0,ge.default)({},a,i);return be(m,c[0],e,xe,l,o)}else _("Entry not found")}0&&(module.exports={decryptSignedKey,encryptKey,getNodeLib,getProjectPath,getStyleLoaderUse,getWebpackConfig,injectHtml,run,uploadAliOss});
