"use strict";/* eslint-disable no-console */var __assign=function(){return __assign=Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++)for(var e in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e]);return a},__assign.apply(this,arguments)},__rest=function(a,b){var c={};for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&0>b.indexOf(d)&&(c[d]=a[d]);if(null!=a&&"function"==typeof Object.getOwnPropertySymbols)for(var e=0,d=Object.getOwnPropertySymbols(a);e<d.length;e++)0>b.indexOf(d[e])&&Object.prototype.propertyIsEnumerable.call(a,d[e])&&(c[d[e]]=a[d[e]]);return c},__spreadArray=function(a,b,c){if(c||2===arguments.length)for(var d,e=0,f=b.length;e<f;e++)(d||!(e in b))&&(d||(d=Array.prototype.slice.call(b,0,e)),d[e]=b[e]);return a.concat(d||Array.prototype.slice.call(b))},__importDefault=function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=exports.getConfig=exports.injectHtmlToRootNode=exports.getSsrLib=void 0;//#region require
var path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),process_1=__importDefault(require("process")),chalk_1=__importDefault(require("chalk")),glob_1=__importDefault(require("glob")),mini_css_extract_plugin_1=__importDefault(require("mini-css-extract-plugin")),css_minimizer_webpack_plugin_1=__importDefault(require("css-minimizer-webpack-plugin")),react_refresh_webpack_plugin_1=__importDefault(require("@pmmmwh/react-refresh-webpack-plugin")),webpackbar_1=__importDefault(require("webpackbar")),clean_webpack_plugin_1=require("clean-webpack-plugin"),webpack_dev_server_1=__importDefault(require("webpack-dev-server")),webpack_1=__importDefault(require("webpack")),webpack_merge_1=__importDefault(require("webpack-merge")),html_webpack_plugin_1=__importDefault(require("html-webpack-plugin")),address_1=__importDefault(require("address")),lib_1=require("./lib");Object.defineProperty(exports,"getSsrLib",{enumerable:!0,get:function get(){return lib_1.getSsrLib}}),Object.defineProperty(exports,"injectHtmlToRootNode",{enumerable:!0,get:function get(){return lib_1.injectHtmlToRootNode}});var tpl_1=__importDefault(require("./tpl")),getProjectPath=function(a){return void 0===a&&(a="./"),path_1.default.join(process_1.default.cwd(),a)};//#endregion
//#region  helper
function exit(a){console.log(chalk_1.default.red(a)),process_1.default.exit(9)}//#endregion
//#endregion
//#region style process
// type: less, sass, css
var getStyleLoaders=function(a,b){void 0===a&&(a="less");var c=[{loader:require.resolve("css-loader"),options:{sourceMap:b}},{loader:require.resolve("postcss-loader"),options:{postcssOptions:{plugins:[require("postcss-preset-env")({autoprefixer:{flexbox:"no-2009"},stage:3})],sourceMap:b}}}];switch(a){case"less":{c.push({loader:require.resolve("less-loader"),options:{lessOptions:{relativeUrls:!1,javascriptEnabled:!0},sourceMap:b}});break}case"sass":{c.push({loader:require.resolve("sass-loader"),options:{sourceMap:b}});break}}return b?c.unshift({loader:require.resolve("style-loader")}):c.unshift({loader:mini_css_extract_plugin_1.default.loader}),c},getBabelOptions=function(a){var b=[[require.resolve("@babel/plugin-transform-runtime")],[require.resolve("@babel/plugin-proposal-decorators"),{legacy:!0}],[require.resolve("@babel/plugin-proposal-class-properties"),{loose:!1}]];return a&&b.push([require.resolve("react-refresh/babel")]),{cacheDirectory:!0,presets:[[require.resolve("@babel/preset-env"),{modules:!1}],require.resolve("@babel/preset-react"),require.resolve("@babel/preset-typescript")],plugins:b}},getAssetConfig=function(a){return{type:"asset",parser:{dataUrlCondition:{maxSize:8192}},generator:{filename:"".concat(a,"/[name].[hash:8][ext]")}}},getHtmlPluginsConfig=function(a,b){void 0===a&&(a=[]),fs_1.default.existsSync(getProjectPath("./index.html"))||fs_1.default.writeFileSync(getProjectPath("./index.html"),tpl_1.default);for(var c,d=[],e=0,f=a;e<f.length;e++)c=f[e],d.push(new html_webpack_plugin_1.default(Object.assign({filename:"".concat(c,".html"),template:getProjectPath("index.html"),chunks:[c,"vendor","common","runtime"]},b?void 0:{minify:{removeComments:!0,collapseWhitespace:!0,removeRedundantAttributes:!0,useShortDoctype:!0,removeEmptyAttributes:!0,removeStyleLinkTypeAttributes:!0,keepClosingSlash:!0,minifyJS:!0,minifyCSS:!0,minifyURLs:!0}})));return d},getConfig=function(a,b,c,d){void 0===a&&(a=!0),void 0===c&&(c="/"),void 0===d&&(d="web");var e=Object.keys(b),f="node"===d,g=f?[]:getHtmlPluginsConfig(e,a),h=e.join("-"),i=f?[{test:/\.(less|sass|scss|css)$/,use:require.resolve("./ignore")}]:[{test:/\.less$/,use:getStyleLoaders("less",a)},{test:/\.s[ac]ss$/i,use:getStyleLoaders("sass",a)},{test:/\.css$/,use:getStyleLoaders("css",a)}],j=[new clean_webpack_plugin_1.CleanWebpackPlugin,new webpack_1.default.DefinePlugin({__dev__:a}),new webpackbar_1.default({name:"w-pack"})];f||(j.push(new mini_css_extract_plugin_1.default({filename:"[name].[contenthash:6].css",chunkFilename:"[name].[contenthash:6].css"})),j.push.apply(j,g));var k={mode:a?"development":"production",bail:!a,entry:b,output:{path:getProjectPath("./dist"),chunkFilename:"[name].[contenthash:6].js",filename:a?"[name].js":"[name].[contenthash:6].js",publicPath:c},devtool:!!a&&"cheap-module-source-map",target:d,cache:a?{type:"filesystem",name:h,buildDependencies:{config:[__filename]},store:"pack"}:{type:"filesystem",name:h+"-prd",buildDependencies:{config:[__filename]},store:"pack"},module:{rules:__spreadArray([{test:/\.[j|t]sx?$/,exclude:/node_modules/,use:{loader:require.resolve("babel-loader"),options:getBabelOptions(a)}},__assign({test:/\.(png|jpg|gif|jpeg|svg)$/},getAssetConfig("images")),__assign({test:/\.(ttf|otf|woff|woff2|eot)$/},getAssetConfig("fonts"))],i,!0)},resolve:{extensions:[".js",".jsx",".ts",".tsx"],alias:{"~":getProjectPath("./src"),"@":getProjectPath("./src")}},optimization:{splitChunks:{name:!1,cacheGroups:{common:{name:"common",chunks:"all",minChunks:2},vendor:{name:"vendor",test:/[\\/]node_modules[\\/]/,chunks:"all",priority:10}}},runtimeChunk:!f&&{name:"runtime"},moduleIds:a?"named":"deterministic",chunkIds:a?"named":"deterministic"},stats:"errors-warnings",plugins:j};return a?k.plugins.push(new react_refresh_webpack_plugin_1.default({overlay:!1})):k.optimization=__assign(__assign({},k.optimization),{minimize:!0,minimizer:[new css_minimizer_webpack_plugin_1.default,"..."]}),k};//#endregion
//#region  babel config
exports.getConfig=getConfig;//#endregion
//#region run
var runWebpack=function(a,b,c,d,e,f){void 0===b&&(b="index");var g;if(c){var h=(0,webpack_1.default)(a),i=__assign({publicPath:"/",compress:!0,host:"0.0.0.0",disableHostCheck:!0,hot:!0,inline:!0,noInfo:!0},e),j=i.port||d;g=new webpack_dev_server_1.default(h,i),g.listen(j,i.host,function(a){a&&exit(a);var c="".concat("index"===b?"":b+".html"),d="http://localhost:".concat(j,"/").concat(c),e="http://".concat(address_1.default.ip(),":").concat(j,"/").concat(c);console.log(),console.log(chalk_1.default.cyan("dev server running at:")),console.log(),console.log("> Local:",chalk_1.default.green("".concat(d))),console.log(),console.log("> Network:",chalk_1.default.green("".concat(e)))})}else{var k=(0,webpack_1.default)(a);k.run(function(a,b){(a||b.hasErrors())&&console.log(b),k.close(function(){console.log(chalk_1.default.green("\u6784\u5EFA\u5B8C\u6210")),null===f||void 0===f?void 0:f()})})}["SIGINT","SIGTERM"].forEach(function(a){process_1.default.on(a,function(){g&&g.close(),process_1.default.exit()})})},run=function(a,b,c,d){var e;void 0===a&&(a="index"),void 0===b&&(b="/"),void 0===c&&(c=!0),void 0===d&&(d=9e3);var f=glob_1.default.sync("./src/".concat(a,"/index{.jsx,.js,.ts,.tsx}")),g=!0;f.length||(f=glob_1.default.sync("./src/index{.jsx,.js,.ts,.tsx}"),!f.length&&exit("\u5165\u53E3\u6587\u4EF6\u672A\u627E\u5230 : ".concat(getProjectPath("./src/index"))),g=!1);var h=f[0],i=(0,exports.getConfig)(c,(e={},e[a]=h,e),b);runWebpack(i,g?a:"index",c,d)};//#endregion
//#region spa mode
exports.run=run;//#endregion
//#region mpa mode
/**
 * node自定义构建
 *
 * @export
 * @param {boolean} isDev 是否开发模式
 * @param {Configuration} config webpack Configuration配置
 * @param {() => void} [callback] 非开发模式编译完成的回调
 * @return {*}
 */function pack(a,b,c){var d=b,e=d.entry,f=d.devServer,g=void 0===f?{}:f,h=__rest(d,["entry","devServer"]);if("object"==typeof e&&e){var i=Object.keys(e);if(i.length){var j=(0,exports.getConfig)(a,e),k=(0,webpack_merge_1.default)({},j,h);return runWebpack(k,i[0],a,9e3,g,c)}exit("\u8BF7\u914D\u7F6Eentry")}else exit("\u8BF7\u914D\u7F6Eentry")}exports.default=pack;